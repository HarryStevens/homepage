<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge;chrome=1">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width">

	<title>Harry Stevens</title>

	<link rel="icon" href="/img/favicon.ico?" type="image/x-icon" />

	<link rel="stylesheet" href="http://harryjstevens.com/css/styles.css" />
	<link rel='stylesheet' href="http://harryjstevens.com/lib/prism.css" />

	<link href="https://fonts.googleapis.com/css?family=PT+Serif" rel="stylesheet">

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/fonts/FontAwesome.otf" />
</head>
<body>
	<div class="header">
		<h1><a href="/ ">Harry Stevens</a></h1>
		<h2>Stories, code and graphics at <b>The Hindustan Times</b>. New Delhi, India.

			<a href="http://twitter.com/harry_stevens/">
				<i class="fa fa-twitter" aria-hidden="true"></i>
			</a>
			<a href="https://github.com/harrystevens">
				<i class="fa fa-github" aria-hidden="true"></i>
			</a>
			<!-- <a href="https://bl.ocks.org/HarryStevens">
				<img src="https://bl.ocks.org/favicon.png" />
			</a> -->

		</h2>
	</div><div class='blog-wrapper'><div>Last updated on 28 April, 2017 | <a href='https://medium.com/@harry_stevens/how-i-built-a-twitter-bot-that-tweets-100-year-old-new-york-times-articles-5253365f9966'><i style='color:#00ab6b' class='fa fa-medium' aria-hidden='true'></i> Originally published on Medium</a></div><h1 name="06da" id="06da" class="graf graf--h3 graf--leading graf--title">How I built a Twitter bot that tweets 100-year-old New York Times&#xA0;articles</h1><p name="c4dd" id="c4dd" class="graf graf--p graf-after--h3">It was with great interest that I learned of <a href="https://1917.rt.com/#!/en" data-href="https://1917.rt.com/#!/en" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">RT 1917</a>, a project that thrusts us into the Russian revolution as its protagonists lived it, one hundred years ago to the day. It&#x2019;s the next best thing to an actual time machine: a bunch of Twitter accounts purporting to be the revolution&#x2019;s major players, live tweeting their &#x201C;experiences.&#x201D;</p><p name="665a" id="665a" class="graf graf--p graf-after--p"><a href="https://twitter.com/VLenin_1917" data-href="https://twitter.com/VLenin_1917" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">Lenin is there</a>, having just arrived in Petrograd from exile, busy releasing his April Theses to the eager proletariat <a href="https://twitter.com/VLenin_1917/status/854079748280123392" data-href="https://twitter.com/VLenin_1917/status/854079748280123392" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">one tweet at a time</a>. So are the former czar and czarina, <a href="https://twitter.com/nicholasii_1917" data-href="https://twitter.com/nicholasii_1917" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">Nicholas Romanov</a> and <a href="https://twitter.com/EmpressAlix1917" data-href="https://twitter.com/EmpressAlix1917" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">Alexandra Fedorovna</a>, trapped in Tsarskoe Selo and watching in horror as their usurpers giddily dismantle everything they&#x2019;ve ever cared about. And <a href="https://twitter.com/JoeStalin_1917" data-href="https://twitter.com/JoeStalin_1917" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">Stalin</a>, still largely unknown to the world, is plotting somewhere in the background, or else endlessly <a href="https://roadupward.wordpress.com/2014/06/28/why-did-stalin-make-doodles-of-wolves/" data-href="https://roadupward.wordpress.com/2014/06/28/why-did-stalin-make-doodles-of-wolves/" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">doodling wolf heads in his notebooks</a>.</p><p name="16b6" id="16b6" class="graf graf--p graf-after--p">Several people, not content merely to watch the events play out, have created their own Twitter accounts as part of the <a href="https://twitter.com/hashtag/1917CROWD" data-href="https://twitter.com/hashtag/1917CROWD" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">#1917CROWD</a>. Among the growing cast of characters, which now numbers in the several dozens, are <a href="https://twitter.com/HudoznikA" data-href="https://twitter.com/HudoznikA" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">a Russian journalist in Paris</a>, <a href="https://twitter.com/Paleologue_1917" data-href="https://twitter.com/Paleologue_1917" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">the French Envoy to the Russian Empire</a>, <a href="https://twitter.com/GMyasnikov_1917" data-href="https://twitter.com/GMyasnikov_1917" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">a Bolshevik metalworker</a>, and <a href="https://twitter.com/GeorgeV_1917" data-href="https://twitter.com/GeorgeV_1917" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">the King of England</a>.</p><p name="e245" id="e245" class="graf graf--p graf-after--p">I, too, wanted to play a part in the drama. But I have neither the knowledge of history nor the time to create a character of my own and respond to events as people tweet about them (I don&#x2019;t even do this very well in the present). Instead, I thought I&#x2019;d write some software to do it for me. What follows is an account of how I did it.</p><h3 name="4c32" id="4c32" class="graf graf--h3 graf-after--p">Step 1: Get New York Times articles about Russia from 100 years ago&#xA0;today.</h3><p name="8cfc" id="8cfc" class="graf graf--p graf-after--h3">The New York Times has an <a href="https://developer.nytimes.com/article_search_v2.json" data-href="https://developer.nytimes.com/article_search_v2.json" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">Article Search API</a> that lets you access all its articles from September 18, 1851, until today. All you have to do is sign up for <a href="https://developer.nytimes.com/signup" data-href="https://developer.nytimes.com/signup" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">an API Key</a> and then write some code to get the articles. For this sort of thing, I&#x2019;m most comfortable with Node.js, so that&#x2019;s what I&#x2019;m going to use. To set up my Node project, I open my Terminal and type:</p><pre name="e747" id="e747" class="graf graf--pre graf-after--p">mkdir nyt-1917<br>cd nyt-1917<br>npm init</pre><p name="1af2" id="1af2" class="graf graf--p graf-after--pre">And press enter until it creates my npm project. Right of the bat, I also need to install the request module, like so:</p><pre name="8881" id="8881" class="graf graf--pre graf-after--p">npm install request --save</pre><p name="c6ff" id="c6ff" class="graf graf--p graf-after--pre">I also want to make my Javascript file:</p><pre name="2e00" id="2e00" class="graf graf--pre graf-after--p">touch index.js</pre><p name="7fa1" id="7fa1" class="graf graf--p graf-after--pre">Now I&#x2019;ll open up Sublime Text and write a little code to get some articles.</p><pre name="daae" id="daae" class="graf graf--pre graf-after--p">var request = require(&quot;request&quot;);</pre><pre name="cea4" id="cea4" class="graf graf--pre graf-after--pre">request.get({<br> url: &quot;<a href="https://api.nytimes.com/svc/search/v2/articlesearch.json" data-href="https://api.nytimes.com/svc/search/v2/articlesearch.json" class="markup--anchor markup--pre-anchor" rel="nofollow noopener noopener nofollow noopener" target="_blank">https://api.nytimes.com/svc/search/v2/articlesearch.json</a>&quot;,<br> qs: {<br>  &quot;api-key&quot;: your_api_key<br> },<br>}, function(err, response, body) {<br> body = JSON.parse(body);<br> console.log(body);<br>});</pre><p name="750e" id="750e" class="graf graf--p graf-after--pre">This will return the most recent articles. But we want articles from 100 years ago today, so we&#x2019;ll get today&#x2019;s date and subtract 100 years from it. Javascript has a <a href="https://www.w3schools.com/jsref/jsref_obj_date.asp" data-href="https://www.w3schools.com/jsref/jsref_obj_date.asp" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">native Date Object</a>, but it&#x2019;s a pain in the ass to use, so we&#x2019;ll use <a href="https://momentjs.com/" data-href="https://momentjs.com/" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">Moment.js</a> to deal with dates. Install Moment like so:</p><pre name="8039" id="8039" class="graf graf--pre graf-after--p">npm install moment --save</pre><p name="c11a" id="c11a" class="graf graf--p graf-after--pre">And then use it to get the date, 100 years ago.</p><pre name="3eee" id="3eee" class="graf graf--pre graf-after--p">var moment = require(&quot;moment&quot;);</pre><pre name="4dd8" id="4dd8" class="graf graf--pre graf-after--pre">var date = moment().subtract(100, &quot;years&quot;); // &quot;today&quot;, but actually 100 years ago</pre><p name="57e5" id="57e5" class="graf graf--p graf-after--pre">Wasn&#x2019;t that easy? Now we can add a few properties to our request to get the articles from 100 years ago today.</p><pre name="81f9" id="81f9" class="graf graf--pre graf-after--p">request.get({<br> url: &quot;<a href="https://api.nytimes.com/svc/search/v2/articlesearch.json" data-href="https://api.nytimes.com/svc/search/v2/articlesearch.json" class="markup--anchor markup--pre-anchor" rel="nofollow noopener nofollow noopener" target="_blank">https://api.nytimes.com/svc/search/v2/articlesearch.json</a>&quot;,<br> qs: {<br>  &quot;api-key&quot;: your_api_key,<br>  &quot;begin_date&quot;: date.format(&quot;YYYYMMDD&quot;),<br>  &quot;end_date&quot;: date.format(&quot;YYYYMMDD&quot;),<br> },<br>}, function(err, response, body) {<br> body = JSON.parse(body);<br> console.log(body);<br>});</pre><p name="02c4" id="02c4" class="graf graf--p graf-after--pre">This will return all sort of articles, many of which have nothing to do with Russia or the revolution. So we&#x2019;ll add a property to filter the results by topic. Here&#x2019;s my query:</p><pre name="8459" id="8459" class="graf graf--pre graf-after--p">var query = &quot;russia OR lenin OR trotsky OR germany OR czar OR socialism&quot;;</pre><p name="53b2" id="53b2" class="graf graf--p graf-after--pre">This will get us stories about Russia and Russians, and we&#x2019;ll also include stories about Germany, since World War I is going on, and many Russians are debating whether to remain in the war or to strike a separate peace with the Germans, so articles about Germany are likely to be of interest to the folks back home in Petrograd. Add the query to the <code class="markup--code markup--p-code">qs</code> object.</p><pre name="7187" id="7187" class="graf graf--pre graf-after--p">request.get({<br>  url: &quot;<a href="https://api.nytimes.com/svc/search/v2/articlesearch.json" data-href="https://api.nytimes.com/svc/search/v2/articlesearch.json" class="markup--anchor markup--pre-anchor" rel="nofollow noopener" target="_blank">https://api.nytimes.com/svc/search/v2/articlesearch.json</a>&quot;,<br>  qs: {<br>    &quot;api-key&quot;: your_api_key,<br>    &quot;fq&quot;: query,<br>    &quot;begin_date&quot;: date.format(&quot;YYYYMMDD&quot;),<br>    &quot;end_date&quot;: date.format(&quot;YYYYMMDD&quot;),<br>  },<br>}, function(err, response, body) {<br>  <br>  body = JSON.parse(body);<br>  console.log(body);</pre><pre name="113b" id="113b" class="graf graf--pre graf-after--pre">});</pre><p name="c492" id="c492" class="graf graf--p graf-after--pre">Now we encounter an interesting thing about the Article Search API: it only returns 10 hits at a time. We can loop through the results 10 at a time by adding another property to the <code class="markup--code markup--p-code">qs</code> object called <code class="markup--code markup--p-code">page</code>, but first we need to know how many pages we&#x2019;re looping through, which means we need to know how many total articles match our query. Fortunately, the API returns that information.</p><pre name="94ba" id="94ba" class="graf graf--pre graf-after--p">var hits = JSON.parse(body).response.meta.hits;<br>var pages = Math.ceil(hits / 10);<br>console.log(&quot;Found &quot; + hits + &quot; articles on &quot; + pages + &quot; pages of results.&quot;);</pre><p name="c2b1" id="c2b1" class="graf graf--p graf-after--pre">Now we know how many pages there are. So, after our initial request, we can write a function that takes as its argument the page number and loops through the pages from 0 (the page index begins at 0, like an array) to the final page, making a request for the articles from each page as it goes.</p><pre name="4e60" id="4e60" class="graf graf--pre graf-after--p">function makeRequest(page){<br>  request.get({<br>    url: &quot;<a href="https://api.nytimes.com/svc/search/v2/articlesearch.json" data-href="https://api.nytimes.com/svc/search/v2/articlesearch.json" class="markup--anchor markup--pre-anchor" rel="nofollow noopener" target="_blank">https://api.nytimes.com/svc/search/v2/articlesearch.json</a>&quot;,<br>    qs: {<br>      &quot;api-key&quot;: your_api_key,<br>      &quot;fq&quot;: query,<br>      &quot;begin_date&quot;: date.format(&quot;YYYYMMDD&quot;),<br>      &quot;end_date&quot;: date.format(&quot;YYYYMMDD&quot;),<br>      &quot;page&quot;: page<br>    },<br>  }, function(err, response, body) {<br>    <br>    body = JSON.parse(body);<br>    console.log(body);</pre><pre name="caed" id="caed" class="graf graf--pre graf-after--pre">  });<br>  <br>}</pre><p name="d909" id="d909" class="graf graf--p graf-after--pre">Now, we could simply loop through those pages with a <code class="markup--code markup--p-code">for</code> loop. But so as to avoid putting unnecessary pressure on the New York Times&#x2019; servers, we&#x2019;ll &#x201C;throttle&#x201D; the requests, spacing them out every ten seconds. For this, I&#x2019;ve used an extension to the <a href="http://underscorejs.org/" data-href="http://underscorejs.org/" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">Underscore.js</a> library. So we install underscore.</p><pre name="4f1d" id="4f1d" class="graf graf--pre graf-after--p">npm install underscore --save</pre><p name="7240" id="7240" class="graf graf--p graf-after--pre">Then we&#x2019;ll add our rate limiting function. I didn&#x2019;t write this function; <a href="https://gist.github.com/mattheworiordan/1084831" data-href="https://gist.github.com/mattheworiordan/1084831" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">this guy did</a>.</p><pre name="9d06" id="9d06" class="graf graf--pre graf-after--p">var _ = require(&quot;underscore&quot;);</pre><pre name="c4ab" id="c4ab" class="graf graf--pre graf-after--pre">// underscore rateLimit function<br>_.rateLimit = function(func, rate, async) {<br>  var queue = [];<br>  var timeOutRef = false;<br>  var currentlyEmptyingQueue = false;<br>  <br>  var emptyQueue = function() {<br>    if (queue.length) {<br>      currentlyEmptyingQueue = true;<br>      _.delay(function() {<br>        if (async) {<br>          _.defer(function() { queue.shift().call(); });<br>        } else {<br>          queue.shift().call();<br>        }<br>        emptyQueue();<br>      }, rate);<br>    } else {<br>      currentlyEmptyingQueue = false;<br>    }<br>  };<br>  <br>  return function() {<br>    var args = _.map(arguments, function(e) { return e; }); // get arguments into an array<br>    queue.push( _.bind.apply(this, [func, this].concat(args)) ); // call apply so that we can pass in arguments as parameters as opposed to an array<br>    if (!currentlyEmptyingQueue) { emptyQueue(); }<br>  };<br>};</pre><p name="5539" id="5539" class="graf graf--p graf-after--pre">And now we&#x2019;ll loop through the pages, making a request every ten seconds.</p><pre name="f800" id="f800" class="graf graf--pre graf-after--p">// a rate-limited version of the request, where it runs<br>// every 10 seconds<br>var makeRequest_limited = _.rateLimit(makeRequest, 10000);</pre><pre name="6e53" id="6e53" class="graf graf--pre graf-after--pre">// loop through the pages<br>for (var i = 0; i &lt; pages; i++){<br>  makeRequest_limited(i);<br>}</pre><p name="197f" id="197f" class="graf graf--p graf-after--pre">So we have our articles. Next, let&#x2019;s turn them into tweets.</p><h3 name="9b53" id="9b53" class="graf graf--h3 graf-after--p">Step 2: Turn the articles into&#xA0;tweets</h3><p name="b1a8" id="b1a8" class="graf graf--p graf-after--h3">Within the request, we&#x2019;ve parsed the <code class="markup--code markup--p-code">body</code> that the API returns by writing the line <code class="markup--code markup--p-code">body = JSON.parse(body)</code>. But to get the actual articles, we&#x2019;ll have to go a little deeper.</p><pre name="183a" id="183a" class="graf graf--pre graf-after--p">var docs = body.response.docs; // the actual articles</pre><p name="ebc0" id="ebc0" class="graf graf--p graf-after--pre">We can loop through these and create tweets out of them. Here&#x2019;s an example that includes a hashtag at the end.</p><pre name="daa9" id="daa9" class="graf graf--pre graf-after--p">//write filtered tweets to json<br>docs.forEach((d, i) =&gt; {<br>  <br>  // an empty object to store data<br>  var obj = {};  </pre><pre name="9214" id="9214" class="graf graf--pre graf-after--pre">  // create the tweet of the headline and a hashtag<br>  obj.headline = d.headline.main<br>  var tweet_start = obj.headline;</pre><pre name="3b2f" id="3b2f" class="graf graf--pre graf-after--pre">  var tweet_end = &quot;#1917LIVE&quot;;</pre><pre name="0664" id="0664" class="graf graf--pre graf-after--pre">  // the 1 is for the space between the tweet and the end<br>  var end_len = tweet_end.length + 1; </pre><pre name="a148" id="a148" class="graf graf--pre graf-after--pre">  // the tweet content is dependent upon the length of the headline<br>  // if the headline is too long, we&apos;ll cut it off, if necessary<br>  // adding 3 dots<br>  if (tweet_start.length &gt; (140 - end_len - 3)) {</pre><pre name="a75a" id="a75a" class="graf graf--pre graf-after--pre">     tweet_start = tweet_start.substr(0, (140 - end_len - 3));</pre><pre name="3a19" id="3a19" class="graf graf--pre graf-after--pre">     // put the elipses after the space<br>     var li = tweet_start.lastIndexOf(&quot; &quot;);<br>     tweet_start = tweet_start.substr(0, li) + &quot;...&quot;;</pre><pre name="4907" id="4907" class="graf graf--pre graf-after--pre">  }</pre><pre name="96a6" id="96a6" class="graf graf--pre graf-after--pre">  obj.tweet = tweet_start.toTitleCase() + &quot; &quot; + tweet_end;</pre><pre name="b897" id="b897" class="graf graf--pre graf-after--pre">});</pre><p name="5c4a" id="5c4a" class="graf graf--p graf-after--pre">I&#x2019;ve added a&#xA0;<code class="markup--code markup--p-code">.toTitleCase()</code> function to the <code class="markup--code markup--p-code">tweet_start</code> string so it&#x2019;s not completely capitalized. This is my function, which I found somewhere on Stack Overflow and modified a bit. I&#x2019;m sure you could write a better one.</p><pre name="7f5b" id="7f5b" class="graf graf--pre graf-after--p">String.prototype.toTitleCase = function() {<br>  var i, j, str, lowers, uppers;<br>  str = this.replace(/([^\W_]+[^\s-]*) */g, function(txt) {<br>    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();<br>  });</pre><pre name="f8c2" id="f8c2" class="graf graf--pre graf-after--pre">// Certain minor words should be left lowercase unless <br>  // they are the first or last words in the string<br>  lowers = [&apos;A&apos;, &apos;An&apos;, &apos;The&apos;, &apos;And&apos;, &apos;But&apos;, &apos;Or&apos;, &apos;For&apos;, &apos;Nor&apos;, &apos;As&apos;, &apos;At&apos;, <br>  &apos;By&apos;, &apos;For&apos;, &apos;From&apos;, &apos;In&apos;, &apos;Into&apos;, &apos;Near&apos;, &apos;Of&apos;, &apos;On&apos;, &apos;Onto&apos;, &apos;To&apos;, &apos;With&apos;];<br>  for (i = 0, j = lowers.length; i &lt; j; i++)<br>    str = str.replace(new RegExp(&apos;\\s&apos; + lowers[i] + &apos;\\s&apos;, &apos;g&apos;), <br>      function(txt) {<br>        return txt.toLowerCase();<br>      });</pre><pre name="7fea" id="7fea" class="graf graf--pre graf-after--pre">  // Certain words such as initialisms or acronyms<br>  // should be left uppercase<br>  uppers = [&apos;Id&apos;, &apos;Tv&apos;];<br>  for (i = 0, j = uppers.length; i &lt; j; i++)<br>    str = str.replace(new RegExp(&apos;\\b&apos; + uppers[i] + &apos;\\b&apos;, &apos;g&apos;), <br>      uppers[i].toUpperCase());</pre><pre name="be71" id="be71" class="graf graf--pre graf-after--pre">  // others<br>  [<br>    {a:&quot;U.s.&quot;,b:&quot;U.S.&quot;},<br>    {a:&quot;Y.m.c.a&quot;,b:&quot;Y.M.C.A&quot;},<br>    {a:&quot;E.h.&quot;,b:&quot;E.H.&quot;},<br>    {a:&quot;C.p.&quot;,b:&quot;C.P.&quot;},<br>    {a:&quot;W.s.&quot;,b:&quot;W.S.&quot;},<br>    {a:&quot;A.n.p.a.&quot;,b:&quot;A.N.P.A&quot;},<br>    {a:&quot;;-&quot;,b:&quot;; &quot;}<br>  ]<br>    .forEach(function(d,i){<br>      str = replaceAll(str, d.a, d.b);    <br>    });<br>  <br>  function replaceAll(string, search, replacement) {<br>    var target = string;<br>    return target.replace(new RegExp(search, &apos;g&apos;), replacement);<br>  };</pre><pre name="7a73" id="7a73" class="graf graf--pre graf-after--pre">  return str;<br>}</pre><p name="611a" id="611a" class="graf graf--p graf-after--pre">The New York Times Article Search API also returns <code class="markup--code markup--p-code">keywords</code> for each article. The keywords often include famous people, so we can check to see if any of the #1917CROWD are subjects of the article. If they are, we&#x2019;ll mention them at the end of the tweet.</p><pre name="3007" id="3007" class="graf graf--pre graf-after--p">// an array for matching famous people<br>var people = [<br>  {<br>    name: &quot;WILSON, WOODROW&quot;,<br>    handle: &quot;POTUS28_1917&quot;<br>  },<br>  {<br>    name: &quot;NICHOLAS II., CZAR OF RUSSIA&quot;,<br>    handle: &quot;NicholasII_1917&quot;<br>  },<br>  {<br>    name: &quot;KERENSKY, ALEXANDER F.&quot;,<br>    handle: &quot;Kerensky_1917&quot;<br>  },<br>  {<br>    name: &quot;WILLIAM II., EMPEROR OF GERMANY&quot;,<br>    handle: &quot;Kaiser_1917&quot;<br>  },<br>  {<br>    name: &quot;TROTZKY, LEON&quot;,<br>    handle: &quot;LeoTrotsky_1917&quot;<br>  },<br>  {<br>    name: &quot;ALFONSO XIII., KING OF SPAIN&quot;,<br>    handle: &quot;AlfonsoXIII1917&quot;<br>  },<br>  {<br>    name: &quot;LENIN, NIKOLAI&quot;,<br>    handle: &quot;VLenin_1917&quot;<br>  },<br>  {<br>    name: &quot;GEORGE V., KING OF ENGLAND&quot;,<br>    handle: &quot;GeorgeV_1917&quot;<br>  },<br>  {<br>    name: &quot;MCADOO, WILLIAM GIBBS&quot;,<br>    handle: &quot;WillMcAdoo_1917&quot;<br>  }<br>];</pre><p name="8c9f" id="8c9f" class="graf graf--p graf-after--pre">These are the people I&#x2019;ve found so far, but there may be more. Let&#x2019;s write some code that goes in the <code class="markup--code markup--p-code">docs</code> loop to check if any of these are present in the keywords. If they are, we&#x2019;ll add them to the end of the tweet.</p><pre name="fcde" id="fcde" class="graf graf--pre graf-after--p">// figure out if any of the 1917crowd are mentioned<br>var persons = d.keywords.filter(function(key){<br>  return key.name == &quot;persons&quot;<br>}).map(function(person){<br>  return person.value<br>});</pre><pre name="7799" id="7799" class="graf graf--pre graf-after--pre">var lookup = people.map(function(p){<br>  return p.name;<br>})<br>var mentions = _.intersection(persons, lookup).map(function(p){<br>  return &quot;@&quot; + _.where(people, {name: p})[0].handle;<br>}); <br>// if they are add them to the end of the tweet<br>if (mentions.length &gt; 0){<br>  tweet_end = tweet_end + &quot; &quot; + mentions.join(&quot; &quot;);<br>}</pre><p name="74bf" id="74bf" class="graf graf--p graf-after--pre">We also want to attach an image of the article itself to the tweet. For this we&#x2019;ll use a module called <a href="https://www.npmjs.com/package/pdf-image" data-href="https://www.npmjs.com/package/pdf-image" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">pdf-image</a> and a module called <a href="https://www.npmjs.com/package/cheerio" data-href="https://www.npmjs.com/package/cheerio" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">cheerio</a> that basically lets us use jQuery in a Node.js environment.</p><pre name="5c4f" id="5c4f" class="graf graf--pre graf-after--p">npm install pdf-image --save<br>npm install cheerio --save</pre><p name="3dc7" id="3dc7" class="graf graf--p graf-after--pre">Add them to the project, preferably somewhere way up at the top. You&#x2019;ll also need to require <code class="markup--code markup--p-code">http</code>, which doesn&#x2019;t need to be installed because it comes with Node.js.</p><pre name="a966" id="a966" class="graf graf--pre graf-after--p">var cheerio = require(&quot;cheerio&quot;),<br>  http = require(&quot;http&quot;),<br>  PDFImage = require(&quot;pdf-image&quot;).PDFImage;</pre><p name="e459" id="e459" class="graf graf--p graf-after--pre">And implement this by requesting the URL that hosts the PDF of the article, downloading that PDF to a <code class="markup--code markup--p-code">temp</code> directory, and converting that PDF file into an image. Again, we do this within the <code class="markup--code markup--p-code">docs</code> loop.</p><pre name="e042" id="e042" class="graf graf--pre graf-after--p">obj.url = &quot;<a href="http://query.nytimes.com/mem/archive-free/pdf?res=" data-href="http://query.nytimes.com/mem/archive-free/pdf?res=" class="markup--anchor markup--pre-anchor" rel="nofollow noopener" target="_blank">http://query.nytimes.com/mem/archive-free/pdf?res=</a>&quot; + d.web_url.split(&quot;res=&quot;)[1];</pre><pre name="b164" id="b164" class="graf graf--pre graf-after--pre">// some variables for creating a unique pdf file name<br>obj.date = d.pub_date.split(&quot;T&quot;)[0];<br>obj.page = page + 1;<br>obj.page_index = i + 1;</pre><pre name="7fad" id="7fad" class="graf graf--pre graf-after--pre">// this is the pdf file name<br>obj.pdf_file_name = &quot;temp/&quot; + obj.date + &quot;_&quot; + obj.page + &quot;_&quot; + obj.page_index + &quot;.pdf&quot;;</pre><pre name="b442" id="b442" class="graf graf--pre graf-after--pre">// a stream to write the pdf file for downloading<br>var file = fs.createWriteStream(output);</pre><pre name="e2de" id="e2de" class="graf graf--pre graf-after--pre">// get the html of the nyt page<br>request(obj.url, function(error, response, body){</pre><pre name="6e16" id="6e16" class="graf graf--pre graf-after--pre">  if (!error &amp;&amp; response.statusCode == 200){<br>    // load cheerio<br>    var $ = cheerio.load(body);</pre><pre name="3d43" id="3d43" class="graf graf--pre graf-after--pre">    // find the pdf url in the response<br>    var pdf = $(&quot;iframe&quot;).attr(&quot;src&quot;);</pre><pre name="d652" id="d652" class="graf graf--pre graf-after--pre">    // download the pdf<br>    var request = http.get(pdf, function(response) {<br>      <br>      // pipe the response to the file<br>      var stream = response.pipe(file);<br>      <br>      // when it&apos;s done, we&apos;ll convert to an image<br>      stream.on(&quot;finish&quot;, function(){</pre><pre name="a919" id="a919" class="graf graf--pre graf-after--pre">        // convert to image, with white background<br>        var pdfImage = new PDFImage(output, {<br>            convertOptions: {<br>                &apos;-background&apos;: &apos;white&apos;,<br>                &apos;-flatten&apos;: &apos;&apos;<br>            }<br>        });</pre><pre name="5d95" id="5d95" class="graf graf--pre graf-after--pre">        pdfImage.convertPage(0).then(function (imagePath) {</pre><pre name="952b" id="952b" class="graf graf--pre graf-after--pre">          console.log(imagePath);</pre><pre name="00ce" id="00ce" class="graf graf--pre graf-after--pre">        });</pre><pre name="a016" id="a016" class="graf graf--pre graf-after--pre">      });</pre><pre name="dc4d" id="dc4d" class="graf graf--pre graf-after--pre">    });<br>    <br>  } else {<br>    console.log(&quot;Error getting PDF&quot;);<br>    console.log(error);<br>  }</pre><pre name="d9bc" id="d9bc" class="graf graf--pre graf-after--pre">});</pre><p name="6864" id="6864" class="graf graf--p graf-after--pre">Now that we&#x2019;ve written some nice tweets and created images to go with them, it&#x2019;s time to send them out into the world.</p><h3 name="a24e" id="a24e" class="graf graf--h3 graf-after--p">Step 3: Send the&#xA0;tweet</h3><p name="cf9e" id="cf9e" class="graf graf--p graf-after--h3">To gain access to Twitter&#x2019;s API, you&#x2019;ll need to <a href="https://apps.twitter.com/" data-href="https://apps.twitter.com/" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">create a Twitter app</a> and follow the steps until you have a consumer key, consumer secret, access token, and access token secret.</p><p name="20d1" id="20d1" class="graf graf--p graf-after--p">The next part&#x2019;s fairly simple, thanks to the excellent <a href="https://www.npmjs.com/package/twit" data-href="https://www.npmjs.com/package/twit" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">Twit</a> module. Go ahead and install that first.</p><pre name="921d" id="921d" class="graf graf--pre graf-after--p">npm install twit --save</pre><p name="d04c" id="d04c" class="graf graf--p graf-after--pre">Now require the module and create a Twit instance using your Twitter app credentials.</p><pre name="be90" id="be90" class="graf graf--pre graf-after--p">var Twit = require(&quot;twit&quot;);</pre><pre name="1ba8" id="1ba8" class="graf graf--pre graf-after--pre">// a new Twit instance<br>var T = new Twit({<br>  consumer_key: your_consumer_key,<br>  consumer_secret: your_consumer_secret,<br>  access_token: your_access_token,<br>  access_token_secret: your_access_token_secret<br>});</pre><p name="c94b" id="c94b" class="graf graf--p graf-after--pre">And then, at the end of the <code class="markup--code markup--p-code">docs</code> loop, here&#x2019;s your code:</p><pre name="a5bb" id="a5bb" class="graf graf--pre graf-after--p">pdfImage.convertPage(0).then(function (imagePath) {                      <br><br>  // post a tweet with media<br>  var b64content = fs.readFileSync(imagePath, { encoding: &quot;base64&quot; });</pre><pre name="c0c4" id="c0c4" class="graf graf--pre graf-after--pre">  // first we must post the media to Twitter<br>  T.post(&quot;media/upload&quot;, { media_data: b64content }, function (err, data, response) {<br>    <br>    // now we can assign alt text to the media<br>    // for use by screen readers and<br>    // other text-based presentations and interpreters<br>    var mediaIdStr = data.media_id_string;<br>    var altText = obj.headline;<br>    var meta_params = { media_id: mediaIdStr, alt_text: { text: altText } };</pre><pre name="c635" id="c635" class="graf graf--pre graf-after--pre">   // create the tweet&apos;s metadata, which contains the image<br>   T.post(&quot;media/metadata/create&quot;, meta_params, function (err, data, response) {<br>      if (!err) {<br>        // now we can reference the media and post a tweet<br>        // (media will attach to the tweet)<br>        var params = { status: obj.tweet, media_ids: [mediaIdStr] }</pre><pre name="4789" id="4789" class="graf graf--pre graf-after--pre">        // post the tweet<br>        T.post(&quot;statuses/update&quot;, params, function (err, data, response) {<br>          if (!err){<br>            // we&apos;ll console log each tweet so we know it was sent       </pre><pre name="77bf" id="77bf" class="graf graf--pre graf-after--pre">            console.log(data.text);<br>            console.log(&quot; &quot;);</pre><pre name="2dae" id="2dae" class="graf graf--pre graf-after--pre">          } else {<br>            console.log(err.message);<br>          }<br>        });</pre><pre name="11e1" id="11e1" class="graf graf--pre graf-after--pre">      }<br>      <br>    });</pre><pre name="7bf2" id="7bf2" class="graf graf--pre graf-after--pre">  });<br>  <br>});</pre><h3 name="5d63" id="5d63" class="graf graf--h3 graf-after--pre">Step 4: Automatically run the code ever&#xA0;hour</h3><p name="2047" id="2047" class="graf graf--p graf-after--h3">Now, if we run <code class="markup--code markup--p-code">node index.js</code>, we&#x2019;ll tweet out everything at once. But that&#x2019;s not how real newspapers use Twitter. Rather, they tweet their stories out over the course of the day. And that&#x2019;s what we want our bot to do.</p><p name="f01d" id="f01d" class="graf graf--p graf-after--p">For this task, we&#x2019;ll need to put our code on some server and run it every hour, only sending out 1/24th of the tweets each time. To do this, we&#x2019;ll be using <a href="http://heroku.com" data-href="http://heroku.com" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">Heroku</a>. If you&#x2019;re new to Heroku, you should create an account and go through the <a href="https://devcenter.heroku.com/articles/getting-started-with-nodejs#introduction" data-href="https://devcenter.heroku.com/articles/getting-started-with-nodejs#introduction" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">tutorial on how to deploy a Node.js app</a>, as that will give you a basic understanding of what comes next.</p><p name="a33c" id="a33c" class="graf graf--p graf-after--p">We are going to be using an addon called Scheduler. If you&#x2019;d like, you can read <a href="http://www.spacjer.com/blog/2014/02/10/defining-node-dot-js-task-for-heroku-scheduler/" data-href="http://www.spacjer.com/blog/2014/02/10/defining-node-dot-js-task-for-heroku-scheduler/" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">a simple tutorial of how to use Scheduler here</a>. Now, in your terminal, you must login to Heroku:</p><pre name="97e2" id="97e2" class="graf graf--pre graf-after--p">heroku login</pre><p name="3e09" id="3e09" class="graf graf--p graf-after--pre">And now you can create the app:</p><pre name="9ba6" id="9ba6" class="graf graf--pre graf-after--p">heroku create nyt-1917</pre><p name="7674" id="7674" class="graf graf--p graf-after--pre">You can deploy your app like so:</p><pre name="ba80" id="ba80" class="graf graf--pre graf-after--p">git push heroku master</pre><p name="5f5d" id="5f5d" class="graf graf--p graf-after--pre">Alright, let&#x2019;s now add the Scheduler addon:</p><pre name="b0c8" id="b0c8" class="graf graf--pre graf-after--p">heroku addons:add scheduler</pre><p name="1db3" id="1db3" class="graf graf--p graf-after--pre">To use Scheduler, you will need to provide a valid credit card. Don&#x2019;t worry, you won&#x2019;t be charged unless you go over a certain usage limit. I&#x2019;ve been running my bot for a while, and my estimated monthly cost, which Heroku provides, is $0.00. In other words, free. Follow the link in your terminal to add your credit card details.</p><p name="9438" id="9438" class="graf graf--p graf-after--p">Once you&#x2019;ve provided your credit card details, you&#x2019;ll need to create a directory called <code class="markup--code markup--p-code">bin</code> and put a file in it called <code class="markup--code markup--p-code">tweet</code> (or any other name you&#x2019;d like to use to describe the process you want to schedule). Note that there is no file extension.</p><pre name="d50b" id="d50b" class="graf graf--pre graf-after--p">mkdir bin<br>touch bin/tweet</pre><p name="057d" id="057d" class="graf graf--p graf-after--pre">Open up that <code class="markup--code markup--p-code">tweet</code> file and add a line at the top called a shebang:</p><pre name="b96d" id="b96d" class="graf graf--pre graf-after--p">#!/usr/bin/env node</pre><p name="36d8" id="36d8" class="graf graf--p graf-after--pre">And copy everything from <code class="markup--code markup--p-code">index.js</code> into the <code class="markup--code markup--p-code">tweet</code> file. Now, there&#x2019;s just one more thing we must add to the code before we start up the Scheduler, because we need to decide which tweets to send out at any given hour of the day. To do that, we&#x2019;ll first get the current hour. Obviously, this will change depending on when the app runs. Somewhere at the top of your code, write:</p><pre name="c8d8" id="c8d8" class="graf graf--pre graf-after--p">var current_hour = moment().format(&quot;H&quot;);</pre><p name="252c" id="252c" class="graf graf--p graf-after--pre">This will return the current hour in 24-hour time. We just need to assign an hour to every tweet, and when we run the code, we&#x2019;ll only send out the tweets whose hours match the <code class="markup--code markup--p-code">current_hour</code>. Within the <code class="markup--code markup--p-code">docs</code> loop, write:</p><pre name="97f3" id="97f3" class="graf graf--pre graf-after--p">obj.page = page + 1;<br>obj.page_index = i + 1;<br>obj.tweet_number = (page * 10) + obj.page_index;<br>        <br>// calculate the hour of the day that the tweet<br>// should go out, based on the total number of tweets<br>obj.hour_of_tweet = Math.round((obj.tweet_number * 24) / hits);</pre><p name="2ab1" id="2ab1" class="graf graf--p graf-after--pre">Before you actually post the tweet, you can write a conditional statement to see if the <code class="markup--code markup--p-code">obj.hour_of_tweet</code> matches the <code class="markup--code markup--p-code">current_hour</code>:</p><pre name="50fc" id="50fc" class="graf graf--pre graf-after--p">if (obj.hour_of_tweet == current_hour){<br>  // here is where you put the code that<br>  // 1. downloads the pdf<br>  // 2. converts it to an image<br>  // 3. posts the tweet<br>  // (see above for instructions on how to do this)<br>}</pre><p name="0d23" id="0d23" class="graf graf--p graf-after--pre">Log in to Heroku, select your app, and, in the top left, under &#x201C;Installed add-ons&#x201D;, select Heroku Scheduler. Click &#x201C;Add new job&#x201D;, where it says <code class="markup--code markup--p-code">rake do_something</code> type <code class="markup--code markup--p-code">tweet</code>, and set the &#x201C;FREQUENCY&#x201D; to &#x201C;Hourly&#x201D;.</p><p name="a2e0" id="a2e0" class="graf graf--p graf-after--p graf--trailing">That&#x2019;s it. Here&#x2019;s <a href="https://twitter.com/NYT_1917" data-href="https://twitter.com/NYT_1917" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">the bot&#x2019;s Twitter page</a>, so you can see it in action, mixing it up with all those famous Russians from 100 years ago. And here&#x2019;s <a href="https://github.com/HarryStevens/nyt-1917" data-href="https://github.com/HarryStevens/nyt-1917" class="markup--anchor markup--p-anchor" rel="noopener nofollow" target="_blank">the GitHub repo</a> with all the code.</p></div><div class="footer">
	<div>Harry Stevens, 2017</div>
	<div><div style="background:#66c2a5" class="swatch"></div><div style="background:#fc8d62" class="swatch"></div><div style="background:#8da0cb" class="swatch"></div></div>
</div><script src='https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script><script src='../../lib/prism.js'></script><script src='../../js/blog.js'></script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-47877483-1', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>